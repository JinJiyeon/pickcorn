{% extends 'base.html' %}
{% load static %}

{% block content %}

  <div class="row">
    <div class="col-sm-5 ">
      <div class="card bg-dark text-white" style="#">
        <img src="https://image.tmdb.org/t/p/original/{{ movie.poster_path }}" class="card-img-top" alt="...">
      </div>
    </div>
    <div class="col-sm-7">
      <div class="card bg-transparent text-white">
        <div class="card-body">
          <h1 class="text-center card-title">{{ movie.title }}</h1>

          <!-- í‰ì  & ì°œí•˜ê¸° ë²„íŠ¼ í•œ ë¸”ëŸ­ì—-->
          <div class="d-flex justify-content-between">
            <p class="card-text">tmdb vote : {{ movie.weighted_vote|floatformat }}</p>
            <form action="{% url 'movies:like' movie.id %}" method="POST" class="like-form d-inline" data-movie-id="{{ movie.pk }}">
              {% csrf_token %}
              <button class="btn btn-outline-primary">
              {% if request.user in movie.like_users.all %}
                <span style="color: Tomato;" class="like-color"><i class="fas fa-heart heart like-fill"></i></span>
              {% else %}
                <span class="like-color"><i class="far fa-heart heart like-fill"></i></span>
              {% endif %}
              </button>
            </form>
          </div>
          
          <p class="card-text">overview : {{ movie.overview }}</p>

          <hr>
            <!-- pickcorn vote -->
            <div>
              <img src="{% static 'pickcorn3.png' %}" width="40"> vote
              <div class="btn-group d-flex justify-content-center" role="group">
                <form action="{% url 'movies:rate_bad' movie.id %}" method="POST">
                  {% csrf_token %}
                  {% if request.user in movie.rated_bad_users.all %}
                    <button class="btn btn-outline-primary"><i class="fas fa-thumbs-down"></i></span></button>
                  {% else %}
                    <button class="btn btn-outline-primary"><i class="far fa-thumbs-down"></i></button>
                  {% endif %}
                </form> 
                <form action="{% url 'movies:rate_good' movie.id %}" method="POST">
                  {% csrf_token %}
                  {% if request.user in movie.rated_good_users.all %}
                    <button class="btn btn-outline-primary"><span style="color: Tomato;"><i class="fas fa-thumbs-up"></i></span></button>
                  {% else %}
                    <button class="btn btn-outline-primary"><i class="far fa-thumbs-up"></i></button>
                  {% endif %}
                </form>  
              </div>
              <p>
                {% if movie_score != 0 %}
                  <div class="progress" style="height: 30px;">
                    <div class="progress-bar bg-warning progress-bar-striped progress-bar-animated" role="progressbar" style="width: {{ movie_score }}%;" aria-valuenow="{{ movie_score }}" aria-valuemin="0" aria-valuemax="100">{{ movie_score }}% ({{ movie_votes }} votes)</div>
                  </div>
                {% else %}
                  <div class="progress" style="height: 30px;">
                    <div class="progress-bar bg-secondary progress-bar-striped" role="progressbar" style="width: 100%;" aria-valuenow="{{ movie_score }}" aria-valuemin="0" aria-valuemax="100" style="color: black;">{{ movie_score }}% ({{ movie_votes }} votes)</div>
                  </div>
                {% endif %}
              </p>
            </div>
          <hr>
            <div class="container">
              <div class="row">
                <div class="col-6">
                  <h4>Ongoing Reviews </h4>
                </div>
                <div class="col-6 d-flex flex-row-reverse">
                  <form action="{% url 'movies:article_create' movie.id %}">
                    <button class="btn btn-success d-block">Add Review ğŸ‘‰</button>
                  </form>
                </div>
              </div>
            </div>

            <br>
            {% if articles|length %}
              <p><b>{{ articles|length }}ê°œì˜ ë¦¬ë·°ê°€ ìˆìŠµë‹ˆë‹¤.</b></p>
                <div class="container">
                  {% for article in posts %}
                    <div class="card my-1 border-0">
                      <a href="{% url 'movies:article_detail' article.pk %}" class="text-decoration-none">
                        <li class="list-group-item d-flex justify-content-between align-items-start bg-dark text-white ">
                          {% if article.user in movie.rated_good_users.all %}
                            <h2>ğŸ˜†</h2>
                          {% elif article.user in movie.rated_bad_users.all %}
                            <h2>ğŸ¤”</h2>
                          {% else %}
                            <h2>ğŸ¥š</h2>
                          {% endif %}
                          <div class="ms-2 me-auto">
                            <div class="fw-bold">{{ article.title }}</div>
                            ì‘ì„±ì: {{ article.user }}
                            ({{ article.created_at|timesince }} ì „)
                          </div>
                          <span class="badge bg-primary rounded-pill"> {{ article.comment_set.count }}  comments </span>
                        </li>
                      </a>
                    </div>
                  {% endfor %}
                
                  <br>
                  <div class="">
                    {% if posts.has_previous %}
                    <a href="?page=1"><button type="button" class="btn btn-warning">first</button></a>
                    <a href="?page={{ posts.previous_page_number }}"><button type="button" class="btn btn-warning">previous</button></a>
                    {% endif %}
                    <span>{{ posts.number }}</span>
                    <span>/</span>
                    <span>{{ posts.paginator.num_pages }}</span>
                    {% if posts.has_next %}
                    <a href="?page={{ posts.next_page_number }}"><button type="button" class="btn btn-warning">next</button></a>
                    <a href="?page={{ posts.paginator.num_pages }}"><button type="button" class="btn btn-warning">last</button></a>
                    {% endif %}
                  </div>
                </div>
              </ol>
            {% else %}
              <p>ì•„ì§ ë¦¬ë·°ê°€ ì—†ì–´ìš”..ğŸ˜¥</p>
            {% endif %}

          <hr>
        </div>
      </div>
    </div>
  </div>

  <hr>

  <div class="container">
    <div class="row gx-5">
      <h3 class="text-white">ì¶”ì²œ ì˜í™”</h3>
      {% for recom in movie.recommends.all %}
        <div class="card bg-transparent text-white col-12 col-md-4">
          <a href="{% url 'movies:detail' recom.pk %}">
            <img src="https://image.tmdb.org/t/p/w500/{{ recom.poster_path }}" class="card-img" alt="...">
            <div class="card-img-overlay">
              <div class="badge bg-primary text-wrap ">
                í‰ì : {{ recom.weighted_vote|floatformat }}
              </div>
            </div>
          </a>
        </div>
      {% endfor %}
    </div>  
  </div>

  <hr>

{% comment %} <script>
  const rateGood = document.querySelector('.rated-good-form')
  const rateBad = document.querySelector('.rated-bad-form')
  const addPlaylist = document.querySelector('.like-form')
  const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]').value

  rateGood.addEventListener('submit', event => {
    event.preventDefault()  
    const movieId = event.target.dataset.movieId
    axios({
      url: `/movies/${movieId}/rate_good/`,
      method: 'post',
      headers : {
        'X-CSRFToken': csrfToken,   
      },
    })
    .then(function (response) {
      const { rated_good, rated_good_count } = response.data
      const ratedGoodColor = document.querySelector(`.rated-good-color`)
      const ratedGoodFill = document.querySelector(`.rated-good-fill`)
      ratedGoodFill.classList.remove('fas', 'far')
      ratedGoodColor.style.color = rated_good? 'Tomato' : ''
      ratedGoodFill.className += rated_good? ' fas' : ' far'
    })
    .catch( function (error) {
      switch (error.response.status) {
        case 401: {
          // ë¡œê·¸ì¸ í˜ì´ì§€ë¡œ ë³´ë‚´ì¤€ë‹¤
          location.href = '/accounts/login/?next='+location.pathname
          break
        }
        default: {
          // ì—ëŸ¬ë©”ì„¸ì§€ë¥¼ ê²½ê³ ì°½ìœ¼ë¡œ í‘œì‹œí•œë‹¤
          alert('ì•Œ ìˆ˜ ì—†ëŠ” ì—ëŸ¬ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤. ê´€ë¦¬ìë¥¼ í†µí•´ ë¬¸ì˜í•´ì£¼ì„¸ìš”.')
        }
      }
    })
  })

  rateBad.addEventListener('submit', event => {
    event.preventDefault()  
    const movieId = event.target.dataset.movieId
    axios({
      url: `/movies/${movieId}/rate_bad/`,
      method: 'post',
      headers : {
        'X-CSRFToken': csrfToken,   
      },
    })
    .then(function (response) {
      const { rated_bad, rated_bad_count } = response.data
      const ratedBadFill = document.querySelector(`.rated-bad-fill`)
      ratedBadFill.classList.remove('fas', 'far')
      ratedBadFill.className += rated_bad? ' fas' : ' far'
    })
    .catch( function (error) {
      switch (error.response.status) {
        case 401: {
          // ë¡œê·¸ì¸ í˜ì´ì§€ë¡œ ë³´ë‚´ì¤€ë‹¤
          location.href = '/accounts/login/?next='+location.pathname
          break
        }
        default: {
          // ì—ëŸ¬ë©”ì„¸ì§€ë¥¼ ê²½ê³ ì°½ìœ¼ë¡œ í‘œì‹œí•œë‹¤
          alert('ì•Œ ìˆ˜ ì—†ëŠ” ì—ëŸ¬ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤. ê´€ë¦¬ìë¥¼ í†µí•´ ë¬¸ì˜í•´ì£¼ì„¸ìš”.')
        }
      }
    })
  }) 

  addPlaylist.addEventListener('submit', event => {
    event.preventDefault()  
    const movieId = event.target.dataset.movieId
    axios({
      url: `/movies/${movieId}/like/`,
      method: 'post',
      headers : {
        'X-CSRFToken': csrfToken,   
      },
    })
    .then(function (response) {
      const { liked, count } = response.data
      const likedColor = document.querySelector(`.like-color`)
      const likedFill = document.querySelector(`.like-fill`)
      likedFill.classList.remove('fas', 'far')
      likedColor.style.color = liked? 'Tomato' : ''
      likedFill.className += liked? ' fas' : ' far'
    })
    .catch( function (error) {
      switch (error.response.status) {
        case 401: {
          // ë¡œê·¸ì¸ í˜ì´ì§€ë¡œ ë³´ë‚´ì¤€ë‹¤
          location.href = '/accounts/login/?next='+location.pathname
          break
        }
        default: {
          // ì—ëŸ¬ë©”ì„¸ì§€ë¥¼ ê²½ê³ ì°½ìœ¼ë¡œ í‘œì‹œí•œë‹¤
          alert('ì•Œ ìˆ˜ ì—†ëŠ” ì—ëŸ¬ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤. ê´€ë¦¬ìë¥¼ í†µí•´ ë¬¸ì˜í•´ì£¼ì„¸ìš”.')
        }
      }
    
        // parameterì— í˜„ì¬ Pathì˜ ì •ë³´ë¥¼ ì‹¬ì–´ì¤˜ì•¼í•¨
        // í˜„ì¬ pathì— ëŒ€í•œ ì •ë³´ë¥¼ nextì— ë‹´ëŠ”ë‹¤
        // ì‚¬ìš©ìë¥¼ ë¡œê·¸ì¸ í˜ì´ì§€ë¡œ ì´ë™ì‹œí‚¨ë‹¤
        // ë¡œê·¸ì¸ìœ¼ë¡œ ì´ë™ì‹œí‚¬ ë•Œ nextë¼ëŠ” íŒŒë¼ë¯¸í„°ê°€ ë¶™ëŠ”ë‹¤
        
    })
  })  {% endcomment %}

  
</script>
{% endblock %}
